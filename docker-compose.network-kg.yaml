# Docker Compose override for Network Knowledge Graph integration
#
# Usage:
#   docker-compose -f docker-compose.yaml -f docker-compose.network-kg.yaml up -d
#
# This adds:
#   - neo4j: Local Neo4j database for network knowledge graph
#   - network-kg-mcp-server: MCP server for network diagnostics
#   - Neo4j environment variables for exchange-server

services:
  # Local Neo4j database
  neo4j:
    image: neo4j:5
    container_name: neo4j-lungo
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - neo4j_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:7474"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Override exchange-server to add Neo4j environment variables
  exchange-server:
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password123
    depends_on:
      neo4j:
        condition: service_healthy

  # Network Knowledge Graph MCP Server
  network-kg-mcp-server:
    build:
      context: ../../..
      dockerfile: coffeeAGNTCY/coffee_agents/lungo/docker/Dockerfile.network-kg
    image: ghcr.io/agntcy/coffee-agntcy/network-kg-mcp-server:latest
    container_name: network-kg-mcp-server
    platform: linux/amd64
    environment:
      # SLIM transport (same as weather-mcp-server)
      - DEFAULT_MESSAGE_TRANSPORT=${DEFAULT_MESSAGE_TRANSPORT:-SLIM}
      - TRANSPORT_SERVER_ENDPOINT=${TRANSPORT_SERVER_ENDPOINT:-http://slim:46357}
      - OTLP_HTTP_ENDPOINT=${OTLP_HTTP_ENDPOINT:-http://otel-collector:4318}
      # Neo4j connection (local)
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password123
    depends_on:
      neo4j:
        condition: service_healthy
      slim:
        condition: service_started

volumes:
  neo4j_data:
